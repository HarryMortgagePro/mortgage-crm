// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model Client {
  id             String          @id @default(cuid())
  firstName      String
  lastName       String
  email          String?
  phone          String?
  type           String?         // Individual / Corporation
  primaryContact String?         // if corporation
  tags           String?         // for filtering/categorization
  referralSource String?         // how they found us
  notes          String?

  applications   Application[]
  properties     Property[]
  bankAccounts   BankAccount[]
  tasks          Task[]
  communications Communication[]

  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
}

model Application {
  id               String   @id @default(cuid())
  clientId         String
  client           Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)

  propertyId       String?  // Optional link to saved property
  property         Property? @relation(fields: [propertyId], references: [id], onDelete: SetNull)

  stage            String   // Lead, App Taken/Background, Submitted, Approval, Funded, Declined

  dealType         String?  // Purchase / Refinance / Switch / HELOC / Private / Commercial
  purpose          String?  // Owner-occupied / Rental / Second home, etc.

  propertyAddress  String?
  propertyCity     String?
  propertyProvince String?
  propertyPostal   String?
  propertyType     String?  // Condo / House / Duplex / Multi-Unit / Commercial
  occupancy        String?  // Owner / Rental / Second Home

  purchasePrice    Float?
  mortgageAmount   Float?
  downPayment      Float?
  amortizationYears Int?
  termYears        Int?
  rateType         String?  // Fixed / Variable
  interestRate     Float?
  lenderName       String?  // Lender name as simple text field

  applicationDate DateTime?
  submissionDate  DateTime?
  approvalDate    DateTime?
  closingDate     DateTime?
  fundedDate      DateTime?
  renewalDate     DateTime? // usually closingDate + termYears

  maxQualification     Float?
  gdsRatio             Float?
  tdsRatio             Float?
  qualificationSummary String?

  notes            String?

  documents       Document[]
  tasks           Task[]
  communications  Communication[]
  commissions     Commission[]
  qualification   Qualification?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model Property {
  id                    String   @id @default(cuid())
  clientId              String
  client                Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)

  // Property Details
  propertyAddress       String
  propertyCity          String
  propertyProvince      String
  propertyType          String?  // Condo / House / Duplex / Multi-Unit / Commercial

  // Default Expenses (to pre-fill calculator)
  propertyTaxAnnual     Float?   // Annual property tax
  heatingMonthly        Float?   // Monthly heating cost
  condoFeesMonthly      Float?   // Monthly condo fees (if applicable)
  otherExpensesMonthly  Float?   // Other monthly property expenses

  notes                 String?

  applications          Application[] // Applications using this property

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

model BankAccount {
  id                  String   @id @default(cuid())
  clientId            String
  client              Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)

  bankName            String?
  accountNickname     String?
  maskedAccountNumber String?
  usedFor             String?
  openedDate          DateTime?
  status              String?
  notes               String?

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
}

model Document {
  id              String   @id @default(cuid())
  applicationId   String
  application     Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  type            String   // NOA, T4, Job Letter, Bank Statements, Purchase Agreement etc.
  required        Boolean  @default(true)
  received        Boolean  @default(false)
  receivedDate    DateTime?
  conditionGroup  String?  // e.g. Income, Down Payment, Property
  conditionStatus String?  // Pending / Sent to lender / Satisfied
  notes           String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model Task {
  id             String   @id @default(cuid())
  title          String
  description    String?
  clientId       String?
  client         Client?  @relation(fields: [clientId], references: [id], onDelete: Cascade)
  applicationId  String?
  application    Application? @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  dueDate        DateTime?
  priority       String?  // Low / Medium / High
  status         String   // Open / In Progress / Completed
  category       String?
  createdForStage String? // optional: stage when task was created

  // Recurring task fields
  isRecurring         Boolean  @default(false)
  recurrenceType      String?  // None, Daily, Weekly, Monthly, Yearly
  recurrenceInterval  Int?     // every X days/weeks/months (e.g., 2 = every 2 weeks)
  recurrenceEndDate   DateTime?

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model Communication {
  id             String   @id @default(cuid())
  clientId       String?
  client         Client?  @relation(fields: [clientId], references: [id], onDelete: Cascade)
  applicationId  String?
  application    Application? @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  date           DateTime @default(now())
  type           String   // Call / Email / SMS / Meeting
  contactName    String?
  summary        String
  nextFollowUp   DateTime?

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model Commission {
  id               String   @id @default(cuid())
  applicationId    String
  application      Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  expectedAmount   Float?
  actualAmount     Float?
  brokerSplitPct   Float?
  myShare          Float?
  referralFee      Float?

  expectedDate     DateTime?
  receivedDate     DateTime?
  reconciled       Boolean @default(false)

  notes            String?

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

model Qualification {
  id                         String      @id @default(cuid())
  applicationId              String      @unique
  application                Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  applicantIncomeMonthly     Float?
  coApplicantIncomeMonthly   Float?
  rentalIncomeMonthly        Float?
  otherIncomeMonthly         Float?

  mortgagePaymentMonthly     Float?
  propertyTaxAnnual          Float?
  heatingMonthly             Float?
  condoFeesMonthly           Float?
  otherPropertyCostsMonthly  Float?

  creditCardsMonthly         Float?
  loansMonthly               Float?
  linesOfCreditMonthly       Float?
  otherDebtsMonthly          Float?

  maxGdsAllowed              Float?
  maxTdsAllowed              Float?

  calculatedGds              Float?
  calculatedTds              Float?
  qualifies                  Boolean?

  createdAt                  DateTime @default(now())
  updatedAt                  DateTime @updatedAt
}
